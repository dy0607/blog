<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>HNOI2015 接水果 | Dy0607's Home</title>

    <!-- Bootstrap CSS -->
<link href="http://localhost:4000//css/bootstrap.min.css" rel='stylesheet' type='text/css'/>
<link href="http://localhost:4000//css/simple-sidebar.css" rel='stylesheet' type='text/css'/>
<link href="http://localhost:4000//css/font-awesome.min.css" rel='stylesheet' type='text/css'/>
<link href="http://localhost:4000//css/font-extra.css" rel='stylesheet' type='text/css'/>
<link href="http://localhost:4000//css/global.css" rel='stylesheet' type='text/css'/>
<link href="http://localhost:4000//css/footer.css" rel='stylesheet' type='text/css'/>

    
    <!--MathJex-->
    <script type="text/x-mathjax-config">
	MathJax.Hub.Config({
  		tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}
	});
	</script>
	<script type="text/javascript"
		src="http://localhost:4000//js/MathJax/MathJax.js?config=TeX-MML-AM_CHTML">
	</script>

	<link href="http://localhost:4000//css/post.css" rel='stylesheet' type="text/css"/>
    <link href="http://localhost:4000//css/md-post-header-collapse.css" rel='stylesheet' type="text/css"/>
    <link href="http://localhost:4000//css/toc.css" rel='stylesheet' type="text/css"/>

	<!--link rel="stylesheet" href="http://localhost:4000//styles/pygment.css" type="text/css"/-->

</head>
<body>
	
    <div id="wrapper" >
		
	    
<!-- Toggle Button -->
 <a href="#menu-toggle" class="btn btn-group-vertical btn-sm toggled" id="menu-toggle">
     <i class="fa fa-bars" aria-hidden="true"></i>
 </a>
 <!-- Sidebar for desktop -->
 <div id="sidebar-wrapper" class="hidden-xs-down">
    <nav class="nav nav-pills flex-sm-row p-3 justify-content-center">
        <a class="flex-sm-fill text-sm-center nav-link active" href="#sidebar-home-content" data-toggle="tab" role="tab" id="home">Home</a>
        <a class="flex-sm-fill text-sm-center nav-link hidden-xl-down" href="#sidebar-toc-content" data-toggle="tab" role="tab" id="toc">Toc</a>
    </nav>
    <div class="tab-content" id="tab-content">
        <div class="tab-pane text-sm-center active" id="sidebar-home-content" >
            <img class="site-author-image m-2" itemprop="image" src="http://cn.gravatar.com/avatar/bf5b26b9b641cbef09e5bc0bff9c7b2b?d=mm&s=256">
			<div style="line-height: 5px; padding-top: 5px;">
				<p class="text-warning">dy0607</p>
				<p class="text-white">keep on coding</p>
			</div>
			<style>
	a.navbartext{
		cursor: pointer; 
		color: gray;
	}

	a.navbartext:hover{
		color: #000000;
	}
</style>

<ul class="sidebar-nav">
    <li title="主页">
        <a href="http://localhost:4000//index.html">
            <i class="fa fa-home" aria-hidden="true"></i>
            Home
        </a>
    </li>
    <li title="博文">
        <a href="http://localhost:4000//index.html#archives">
            <i class="fa fa-file-archive-o" aria-hidden="true"></i>
            Archives 
             <span class="text-warning pull-right">24</span>
		</a>
    </li>
    <li title="分类">
        <a href="http://localhost:4000//categories.html">
            <i class="fa fa-tags" aria-hidden="true"></i>
            Categories
            <span class="text-warning pull-right">6</span>
        </a>
    </li>
    <li title="友情链接">
        <a href="http://localhost:4000//friends.html" >
            <i class="fa fa-users" aria-hidden="true"></i>
            Friends
        </a>
    </li>
	<li title="关于">
        <a href="http://localhost:4000//about.html" >
            <i class="fa fa-user" aria-hidden="true"></i>
            About
        </a>
    </li>
    <li title="搜索">
    	<a class="navbartext" href="#search" id="cb-search-btn" style="">
			<i class="fa fa-search" aria-hidden="true"></i>
			Search
		</a>
	<li>
</ul>

        </div>
        <div class="tab-pane fade text-sm-left" id="sidebar-toc-content">
        </div>
    </div>
    
</div>

<!-- Navbar for xsmall screen  -->
<div class="hidden-sm-up">
    <nav class="navbar navbar-toggleable-md navbar-light bg-faded">
        <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <a class="navbar-brand" href="#">Dy0607's Home</a>
        <div class="collapse navbar-collapse" id="navbarNav">
            <style>
	a.navbartext{
		cursor: pointer; 
		color: gray;
	}

	a.navbartext:hover{
		color: #000000;
	}
</style>

<ul class="sidebar-nav">
    <li title="主页">
        <a href="http://localhost:4000//index.html">
            <i class="fa fa-home" aria-hidden="true"></i>
            Home
        </a>
    </li>
    <li title="博文">
        <a href="http://localhost:4000//index.html#archives">
            <i class="fa fa-file-archive-o" aria-hidden="true"></i>
            Archives 
             <span class="text-warning pull-right">24</span>
		</a>
    </li>
    <li title="分类">
        <a href="http://localhost:4000//categories.html">
            <i class="fa fa-tags" aria-hidden="true"></i>
            Categories
            <span class="text-warning pull-right">6</span>
        </a>
    </li>
    <li title="友情链接">
        <a href="http://localhost:4000//friends.html" >
            <i class="fa fa-users" aria-hidden="true"></i>
            Friends
        </a>
    </li>
	<li title="关于">
        <a href="http://localhost:4000//about.html" >
            <i class="fa fa-user" aria-hidden="true"></i>
            About
        </a>
    </li>
    <li title="搜索">
    	<a class="navbartext" href="#search" id="cb-search-btn" style="">
			<i class="fa fa-search" aria-hidden="true"></i>
			Search
		</a>
	<li>
</ul>

        </div>
    </nav>
</div>
 
	   <!-- jQuery first, then Tether, then Bootstrap JS. -->
<script src="http://localhost:4000//js/jquery-3.1.1.min.js"></script>
<script src="http://localhost:4000//js/tether.min.js"></script>
<script src="http://localhost:4000//js/bootstrap.min.js"></script>

<!-- automatically push links to Baidu -->
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>

	   <!-- Page Content -->
<div id="page-content-wrapper">
    <div class="container-fluid" id="post-content">
        <div class="row">		   
	   		<div class="pagewidth">
            <div class="col-md-12">
                <div class="page-header">
                    <h1 class="text-danger">
                        HNOI2015 接水果
                    </h1></p>
                    <B>Date: <span class="badge badge-primary">2017-04-12</span></B></p>
                    <B>分类:  </B>
                    
    					<a href="http://localhost:4000//categories.html">
						<span class="badge badge-primary">省选</span></a>&nbsp;
    				
    				<B>|&nbsp;</B>
                    <B>标签:  </B>
                    
    					<a href="http://localhost:4000//categories.html">
						<span class="badge badge-primary">莫队</span></a>&nbsp;
    				
    				</p>
                    </p>
                </div>
                <h2 id="description">Description</h2>

<p>风见幽香非常喜欢玩一个叫做 osu!的游戏，其中她最喜欢玩的模式就是接水果。由于她已经DT FC 了The big black, 她觉得这个游戏太简单了，于是发明了一个更加难的版本。</p>

<p>首先有一个地图，是一棵由 $n$ 个顶点、$n-1$ 条边组成的树。</p>

<p>这颗树上有 $P$ 个盘子，每个盘子实际上是一条路径），并且每个盘子还有一个权值。第 $i$ 个盘子就是顶点$a_i$到顶点$b_i$的路径(由于是树，所以从$a_i$到$b_i$的路径是唯一的)，权值为$c_i$。</p>

<p>接下来依次会有$Q$个水果掉下来，每个水果本质上也是一条路径，第i 个水果是从顶点 $u_i$ 到顶点$v_i$ 的路径。</p>

<p>幽香每次需要选择一个盘子去接当前的水果：一个盘子能接住一个水果，当且仅当盘子的路径是水果的路径的子路径．这里规定:从$a$ 到$b$的路径与从$b$到 $a$的路径是同一条路径。</p>

<p>当然为了提高难度，对于第 $i$ 个水果，你需要选择能接住它的所有盘子中，权值第 $k_i$ 小的那个盘子，每个盘子可重复使用（没有使用次数的上限：一个盘子接完一个水果后，后面还可继续接其他水果，只要它是水果路径的子路径）。幽香认为这个游戏很难，你能轻松解决给她看吗？</p>

<h2 id="input">Input</h2>

<p>第一行三个数 $n,P ,Q,(n, P, q \le 4 \times 10^4)$表示树的大小和盘子的个数和水果的个数。 接下来$n-1$ 行，每行两个数 $a,b,$表示树上的$a,b$ 之间有一条边。树中顶点按$1$到 $n$标号。 接下来 $P$ 行，每行三个数 $a、b、c$，表示路径为 $a$ 到 $b$、权值为 $c$ 的盘子，其中$0\le c \le 10^9$，$a \ne b$。 接下来$Q$行，每行三个数 $u、v、k$，表示路径为 $u$到 $v$的水果，其中 $u$不等于$v$，你需要选择第 $k$小的盘子，第$k$ 小一定存在。</p>

<h2 id="output">Output</h2>

<p>对于每个果子，输出一行表示选择的盘子的权值。</p>

<h2 id="solution">Solution</h2>

<p>这题做法很多，用整体二分可以很方便地解决．不过莫队也是可以水的．</p>

<p>用树上莫队的套路排序好询问后，加入一个点时，考虑以这个点为端点的所有盘子，若另一个端点也在当前的链上，将其离散化后的权值加入线段树（树状数组，平衡树等支持第$k$大的均可），删除同理．注意以LCA为端点的盘子需要在询问时加入再删掉，然而这样有可能会破坏复杂度（事实上很难在看不到代码的情况下卡掉，因为DFS树根节点的选择也会影响LCA的位置）．</p>

<p>这样我们就得到了一个时间复杂度$O(n^\frac{3}{2}logP + q logP)$的高(la)效(ji)算法．由于我在插入时使用的是树状数组(本意是想减小常数)，询问时二分还多带了一个$log$．</p>

<h2 id="source">Source</h2>

<pre><code class="c++">#include &lt;cstdio&gt;
#include &lt;algorithm&gt;
#include &lt;vector&gt;
#include &lt;cmath&gt;

#define For(i, j, k) for(int i = j; i &lt;= k; i++)
#define Forr(i, j, k) for(int i = j; i &gt;= k; i--)
#define pb push_back

using namespace std;

const int N = 80010;

int n, m, q, sz;
vector&lt;int&gt; G[N];

struct Query{
	int l, r, lca, k, id;

	bool operator &lt; (const Query&amp; A) const{
		return l / sz == A.l / sz ? r &lt; A.r : l &lt; A.l;
	}
}A[N];

struct Plate{
	int to, val;
}B[N];

int Begin[N], Next[N], e;
void Add(int x, int y, int w){
	B[++e] = (Plate){y, w};
	Next[e] = Begin[x];
	Begin[x] = e;
}

int in[N], out[N], id[N], dfn;
int dep[N], fa[N][18];

void DFS(int h){
	in[h] = ++dfn, id[dfn] = h;
	For(i, 0, (int)G[h].size() - 1){
		int v = G[h][i];
		if(v == fa[h][0]) continue;
		fa[v][0] = h;
		For(j, 1, 17) fa[v][j] = fa[fa[v][j - 1]][j - 1];
		dep[v] = dep[h] + 1;
		DFS(v);
	}
	out[h] = ++dfn, id[dfn] = h;
}

int num[N], Ans[N], tot;

void findlca(Query&amp; p){
	if(in[p.l] &gt; in[p.r]) swap(p.l, p.r);
	int u = p.l, v = p.r;
	if(dep[u] &lt; dep[v]) swap(u, v);
	int del = dep[u] - dep[v];
	Forr(i, 17, 0) if(del &amp; (1 &lt;&lt; i)) u = fa[u][i];
	if(u != v){
		Forr(i, 17, 0) if(fa[u][i] ^ fa[v][i]) u = fa[u][i], v = fa[v][i];
		p.lca = fa[u][0];
		p.l = out[p.l], p.r = in[p.r];
	}
	else p.l = in[p.l], p.r = in[p.r];
}

int c[N];

inline int lowbit(int x){
	return x &amp; (-x);
}

inline void add(int x, int v){
	while(x &lt;= n){
		c[x] += v;
		x += lowbit(x);
	}
}

inline int sum(int x){
	int ret = 0;
	while(x){
		ret += c[x];
		x -= lowbit(x);
	}
	return ret;
}

bool vis[N];

void change(int x){
	x = id[x];
	for(int i = Begin[x]; i; i = Next[i])
		if(vis[B[i].to]) add(B[i].val, vis[x] ? -1 : 1);
	vis[x] ^= 1;
}

int query(int k, int u){
	for(int i = Begin[u]; i; i = Next[i]) 
		if(vis[B[i].to]) add(B[i].val, 1);
	int L = 1, R = tot, M;
	while(L &lt; R){
		M = (L + R) &gt;&gt; 1;
		if(sum(M) &gt;= k) R = M;
		else L = M + 1;
	}
	for(int i = Begin[u]; i; i = Next[i]) 
		if(vis[B[i].to]) add(B[i].val, -1);
	return num[L];
}

int main(){
	scanf("%d%d%d", &amp;n, &amp;m, &amp;q);
	For(i, 2, n){
		int u, v;
		scanf("%d%d", &amp;u, &amp;v);
		G[u].pb(v), G[v].pb(u);
	}
	DFS(1);
	For(i, 1, m){
		int x, y, v;
		scanf("%d%d%d", &amp;x, &amp;y, &amp;v);
		num[++tot] = v;
		Add(x, y, v), Add(y, x, v);
	}

	sort(num + 1, num + tot + 1);
	tot = (int)(unique(num + 1, num + tot + 1) - num) - 1;
	For(i, 1, e) B[i].val = (int)(lower_bound(num + 1, num + tot + 1, B[i].val) - num);

	For(i, 1, q) scanf("%d%d%d", &amp;A[i].l, &amp;A[i].r, &amp;A[i].k), A[i].id = i, findlca(A[i]);
	sz = ceil(sqrt(2 * n));
	sort(A + 1, A + q + 1);

	int l = 0, r = 0;
	For(i, 1, q){
		while(r &lt; A[i].r) change(++r);
		while(r &gt; A[i].r) change(r--);
		while(l &lt; A[i].l) change(l++);
		while(l &gt; A[i].l) change(--l);
		Ans[A[i].id] = query(A[i].k, A[i].lca);
	}

	For(i, 1, q) printf("%d\n", Ans[i]);
	return 0;
}
</code></pre>

                </p></p>

                <!-- don't delete this div as this is header collapse end identified  -->
                <div id="content-end"></div>
                <div></div>
                </div>
            </div>

        </div>
    </div>
<!-- /#page-content-wrapper -->

	   <div class="pagewidth">
<div class="row">
    <div class="col-md-12">
        <div id="disqus_thread"></div>
        <script>
          var disqus_config = function () {
            this.page.url = 'https://dy0607.github.io';  
            this.page.identifier = 'https://dy0607.github.io/dy0607.github.io/index.html';
          };
          
          (function() { // DON'T EDIT BELOW THIS LINE
          var d = document, s = d.createElement('script');
          s.src = 'https://dy0607.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
          })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    </div>
</div>
</div>

	   <footer class="mt-5 pt-5">
  <div class="container">
    <div class="row">
      <div class="col-md-6">
        <strong>Credits</strong>
        <table class="table table-sm">
          <tr>
            <td>Original theme by:</td>
            <td>Szhshp</td>
          </tr>
          <tr>
            <td>Engine:</td>
            <td>Ruby x Jekyll</td>
          </tr>
          </table>
	  <p class="text-muted">Copyright &copy; dy0607 2018</p>
        </div>

        <div class="col-md-6">
          <strong>External Links</strong>
        <table class="table table-sm">
		<tr>
		  <td><a href="http://codeforces.com"> Codeforces</a></td>
		</tr>
		<tr>
		  <td><a href="https://atcoder.jp"> Atcoder</a></td>
		</tr>
		<tr>
		  <td><a href="https://github.com/"> Github</a></td>
		</tr>
		<tr>
		  <td><a href="http://uoj.ac">UOJ</a></td>
		</tr>
		</table>

      </div>
    </div>  
   
    <!--search engine-->
    <link rel="stylesheet" href="http://localhost:4000//search/css/cb-search.css">

	<div class="cb-search-tool" style="position: fixed; top: 0px ; bottom: 0px; left: 0px; right: 0px;
		  opacity: 0.95; background-color: #000; z-index: 9999; display: none;">
		<input type="text" class="form-control cb-search-content" id="cb-search-content" 
			style="position: fixed; top: 60px; " placeholder="Search for titles or tags..." >

		<div style="position: fixed; top: 30px; right: 260px;">
		    <a class="btn btn-group-vertical btn-sm" id="cb-close-btn">
				<i class="fa fa-close" aria-hidden="true"></i>
			</a>
		</div>
	</div>

	
	<script src="http://localhost:4000//search/js/bootstrap3-typeahead.min.js"></script>
	<script src="http://localhost:4000//search/js/cb-search.js"></script>

  </footer>
  
<!--player-->
<!--
<embed src="http://www.xiami.com/widget/0_2096838/singlePlayer.swf" 
	type="application/x-shockwave-flash" width="252" height="33" wmode="transparent" style="position: fixed; bottom: 0; left: 30px; opacity: 0.5;"></embed>
-->
  


    </div>
    
   <!-- New Highlighter : you can change the theme here -->
   <link rel="stylesheet" href="http://localhost:4000//styles/gruvbox-dark.css"/>
	<script src="http://localhost:4000//js/highlight.pack.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>
	
   <!-- Old Highlighter : do not remove it or there may be a compile error in post.js -->
   <script src="http://localhost:4000//js/shCore.js" type='text/javascript'></script>

   <!-- Header collapse -->
   <script src="http://localhost:4000//js/md-post-header-collapse.js" type="text/javascript"></script>

   <script src="http://localhost:4000//js/sidebar.js" type="text/javascript"></script>
   <script src="http://localhost:4000//js/post.js" type="text/javascript"></script>
   <script src="http://localhost:4000//js/toc.js" type="text/javascript"></script>


</body>
</html>

